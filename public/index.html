<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>React Redux UnderTheHood</title>
  <link rel="stylesheet" href="styles.css">
  <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
  <div id="root"></div>

  <script type="text/own">

    // Imitate API
    const api = {
      get(url) {
        switch (url) {
          case '/lots':
            return new Promise((resolve, _) => {
              const mockLots = [
                {
                  id: 1,
                  name: "Apple",
                  description: "Apple description",
                  price: 16
                }, {
                  id: 2,
                  name: "Orange",
                  description: "Orange description",
                  price: 41
                }]

              // resolve promise with mocked lots after timeout to imitate fetching
              setTimeout(() => {
                resolve(mockLots)
              }, 1000)

            })
          default:
            throw new Error('Unknown address')
        }
      }
    }

    // Imitate web sockets
    const stream = {
      subscribe(channel, listener) {
        const match = /price-(\d+)/.exec(channel)
        if (match) {
          setInterval(() => {
            listener({
              id: parseInt(match[1]),
              price: Math.round(Math.random() * 10 + 30)
            })
          }, 400)
        }
      }
    }

    // State
    let state = {
      currentTime: new Date(),
      lots: null
    }

    // App node
    function App({ state }) {
      return React.createElement('main', { className: 'app' }, [
        React.createElement(Header),
        React.createElement(Clock, { time: state.currentTime }),
        React.createElement(Lots, { lots: state.lots })
      ])
    }

    // Header node
    function Header() {
      return React.createElement('header', { className: 'header' }, React.createElement(Logo))
    }

    // Logo node
    function Logo() {
      return React.createElement('img', {
        className: 'logo',
        src: './chilli.png',
        alt: 'Chilli illustration'
      })
    }

    // Clock node
    function Clock({ time }) {
      const isDay = time.getHours() >= 7 && time.getHours() <= 21

      return React.createElement('div', { className: 'clock', }, [
        React.createElement('span', { className: 'value' }, time.toLocaleTimeString()),
        React.createElement('span', { className: isDay ? 'icon day' : 'icon night' })
      ])
    }

    // Loading node
    function Loading() {
      return React.createElement('div', { className: 'loading', }, 'Loading')
    }

    // Lots node
    function Lots({ lots }) {
      if (lots === null) {
        return React.createElement(Loading)
      }

      return React.createElement(
        'div',
        { className: 'lots' },
        lots.map(lot => React.createElement(Lot, { lot, key: lot.id })))
    }

    // Lot node
    function Lot({ lot, key }) {
      return React.createElement('article', { className: 'lot', key }, [
        React.createElement('div', { className: 'price', }, lot.price),
        React.createElement('h1', {}, lot.name),
        React.createElement('p', {}, lot.description),
      ])
    }

    // Render app helper
    function renderApp(state) {
      ReactDOM.render(
        React.createElement(App, { state }),
        document.getElementById('root')
      )
    }

    // First render
    renderApp(state)

    // Make api call after first render
    api.get('/lots')
      .then(lots => {
        state = { ...state, lots }

        // rerender app after receiving api response with the new state
        renderApp(state)

        const onPrice = (data) => {
          const lotsWithUpdatedPrice = state.lots.map(lot => {
            if (lot.id !== data.id) return lot
            return { ...lot, price: data.price }
          })
          state = {
            ...state,
            lots: lotsWithUpdatedPrice
          }

          // rerender on every price update with the new state
          renderApp(state)
        }

        // subscribe to a pseudo web socket to update prices for each lots element
        lots.forEach(lot => {
          stream.subscribe(`price-${lot.id}`, onPrice)
        })
      })
      .catch(console.log)

    // Rerender the app on each tick (time update)
    setInterval(() => {
      state = {
        ...state,
        currentTime: new Date()
      }
      renderApp(state)
    }, 1000)
  </script>

  <script>
    function convertToBrowserJS(code) {
      return Babel.transform(code, { presets: ['stage-3'] }).code
    }

    const scripts = document.querySelectorAll('script[type="text/own"]')
    scripts.forEach(el => {
      const js = convertToBrowserJS(el.text)
      const script = document.createElement('script')
      script.text = js
      document.querySelector('body').append(script)
    })
  </script>
</body>

</html>
